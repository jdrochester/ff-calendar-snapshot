name: Fetch Stock Earnings Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch earnings calendar
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
        run: |
          set -e
          python3 - << 'EOF'
          import os
          import json
          import requests
          from datetime import datetime, timedelta, timezone
          from pathlib import Path

          api_key = os.environ.get("FMP_API_KEY", "").strip()
          if not api_key:
              raise SystemExit("Missing FMP_API_KEY (set it in repo secrets).")

          base_url = "https://financialmodelingprep.com/api/v3/earning_calendar"

          tickers_path = Path("tickers.json")
          if not tickers_path.exists():
              raise SystemExit("Missing tickers.json in repo root.")

          tickers = json.loads(tickers_path.read_text(encoding="utf-8"))
          if not isinstance(tickers, list) or not tickers:
              raise SystemExit("tickers.json must be a non-empty JSON array of tickers.")

          all_events = []
          today = datetime.now(timezone.utc).date()
          end = today + timedelta(days=45)

          for ticker in tickers:
              ticker = str(ticker).strip()
              if not ticker:
                  continue

              url = f"{base_url}?symbol={ticker}&apikey={api_key}"
              print("Fetching", ticker)

              try:
                  resp = requests.get(url, timeout=10)
                  data = resp.json()
              except Exception as e:
                  print("HTTP/JSON error for", ticker, ":", e)
                  continue

              if not isinstance(data, list):
                  print("Non-list response for", ticker, ":", data)
                  continue

              for ev in data:
                  if not isinstance(ev, dict):
                      continue

                  date = ev.get("date")
                  if not date:
                      continue

                  try:
                      d = datetime.strptime(date, "%Y-%m-%d").date()
                  except Exception:
                      continue

                  if d < today or d > end:
                      continue

                  all_events.append({
                      "ticker": ticker,
                      "date": date,
                      "time": ev.get("time", ""),
                      "exchange": ev.get("exchange", ""),
                      "eps_estimate": ev.get("epsEstimated"),
                      "revenue_estimate": ev.get("revenueEstimated")
                  })

          Path("StockEarningsCal.json").write_text(
              json.dumps(all_events, indent=2),
              encoding="utf-8"
          )

          print("Parsed", len(all_events), "earnings events")
          EOF

      - name: Commit earnings calendar
        run: |
          git config user.name "earnings-bot"
          git config user.email "bot@github.com"
          git add StockEarningsCal.json
          git commit -m "Update stock earnings calendar" || echo "No changes to commit"
          git push
