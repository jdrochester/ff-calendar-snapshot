name: Fetch Stock Earnings Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch earnings from Nasdaq (date-based)
        run: |
          set -e
          python3 - << 'EOF'
          import json
          import requests
          from datetime import datetime, timedelta, timezone
          from pathlib import Path

          BASE_URL = "https://api.nasdaq.com/api/calendar/earnings"

          HEADERS = {
              "User-Agent": "Mozilla/5.0",
              "Accept": "application/json",
              "Referer": "https://www.nasdaq.com/market-activity/earnings"
          }

          tickers = set(
              t.strip().upper()
              for t in json.loads(Path("tickers.json").read_text())
              if t.strip()
          )

          today = datetime.now(timezone.utc).date()
          end = today + timedelta(days=45)

          all_events = []

          cur = today
          while cur <= end:
              date_str = cur.isoformat()
              print("Fetching earnings for", date_str)

              try:
                  r = requests.get(
                      BASE_URL,
                      params={"date": date_str},
                      headers=HEADERS,
                      timeout=10
                  )
                  data = r.json()
              except Exception as e:
                  print("HTTP/JSON error for", date_str, ":", e)
                  cur += timedelta(days=1)
                  continue

              payload = data.get("data")
              if not isinstance(payload, dict):
                  cur += timedelta(days=1)
                  continue

              rows = payload.get("rows", [])
              if not isinstance(rows, list):
                  cur += timedelta(days=1)
                  continue

              for ev in rows:
                  symbol = ev.get("symbol")
                  if not symbol:
                      continue

                  symbol = symbol.upper()
                  if symbol not in tickers:
                      continue

                  all_events.append({
                      "ticker": symbol,
                      "date": date_str,
                      "time": ev.get("time", ""),   # BMO / AMC / empty
                      "eps_estimate": ev.get("epsForecast")
                  })

              cur += timedelta(days=1)

          Path("StockEarningsCal.json").write_text(
              json.dumps(all_events, indent=2),
              encoding="utf-8"
          )

          print("Parsed", len(all_events), "earnings events")
          EOF

      - name: Commit earnings calendar
        run: |
          git config user.name "earnings-bot"
          git config user.email "bot@github.com"
          git add StockEarningsCal.json
          git commit -m "Update stock earnings calendar" || echo "No changes to commit"
          git push
