python3 << 'EOF'
import json
import requests
from datetime import datetime, timedelta, timezone
from pathlib import Path

API_KEY = "${FMP_API_KEY}"
BASE_URL = "https://financialmodelingprep.com/api/v3/earning_calendar"

# Load tickers
tickers = json.load(open("tickers.json"))

all_events = []

today = datetime.now(timezone.utc).date()
end = today + timedelta(days=45)

for ticker in tickers:
    url = f"{BASE_URL}?symbol={ticker}&apikey={API_KEY}"
    print(f"ðŸ”Ž Fetching {ticker}")

    try:
        resp = requests.get(url, timeout=10)
        data = resp.json()
    except Exception as e:
        print(f"âŒ HTTP error for {ticker}: {e}")
        continue

    # Defensive checks
    if not isinstance(data, list):
        print(f"âš ï¸ Non-list response for {ticker}: {data}")
        continue

    for ev in data:
        if not isinstance(ev, dict):
            continue

        date = ev.get("date")
        if not date:
            continue

        try:
            d = datetime.strptime(date, "%Y-%m-%d").date()
        except Exception:
            continue

        if d < today or d > end:
            continue

        all_events.append({
            "ticker": ticker,
            "date": date,
            "time": ev.get("time", ""),
            "exchange": ev.get("exchange", ""),
            "eps_estimate": ev.get("epsEstimated"),
            "revenue_estimate": ev.get("revenueEstimated")
        })

Path("StockEarningsCal.json").write_text(
    json.dumps(all_events, indent=2),
    encoding="utf-8"
)

print(f"âœ… Parsed {len(all_events)} earnings events")
EOF
