name: Fetch Stock Earnings Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # 3am UTC (~11pm ET previous day)

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch earnings from Nasdaq
        run: |
          set -e
          python3 - << 'EOF'
          import json
          import requests
          from datetime import datetime, timedelta, timezone
          from pathlib import Path

          BASE_URL = "https://api.nasdaq.com/api/calendar/earnings"

          HEADERS = {
              "User-Agent": "Mozilla/5.0",
              "Accept": "application/json",
              "Referer": "https://www.nasdaq.com/market-activity/earnings"
          }

          tickers_path = Path("tickers.json")
          if not tickers_path.exists():
              raise SystemExit("Missing tickers.json in repo root.")

          tickers = json.loads(tickers_path.read_text(encoding="utf-8"))
          if not isinstance(tickers, list) or not tickers:
              raise SystemExit("tickers.json must be a non-empty JSON array.")

          today = datetime.now(timezone.utc).date()
          end = today + timedelta(days=45)

          all_events = []

          for ticker in tickers:
              ticker = str(ticker).strip().upper()
              if not ticker:
                  continue

              print("Fetching", ticker)

              try:
                  r = requests.get(
                      BASE_URL,
                      params={"symbol": ticker},
                      headers=HEADERS,
                      timeout=10
                  )
                  data = r.json()
              except Exception as e:
                  print("HTTP/JSON error for", ticker, ":", e)
                  continue

              rows = data.get("data", {}).get("rows", [])
              if not isinstance(rows, list):
                  print("No earnings rows for", ticker)
                  continue

              for ev in rows:
                  date_str = ev.get("earningsDate")
                  if not date_str:
                      continue

                  try:
                      d = datetime.strptime(date_str[:10], "%Y-%m-%d").date()
                  except Exception:
                      continue

                  if d < today or d > end:
                      continue

                  all_events.append({
                      "ticker": ticker,
                      "date": d.isoformat(),
                      "time": ev.get("time", ""),     # BMO / AMC / empty
                      "eps_estimate": ev.get("epsForecast")
                  })

          Path("StockEarningsCal.json").write_text(
              json.dumps(all_events, indent=2),
              encoding="utf-8"
          )

          print("Parsed", len(all_events), "earnings events")
          EOF

      - name: Commit earnings calendar
        run: |
          git config user.name "earnings-bot"
          git config user.email "bot@github.com"
          git add StockEarningsCal.json
          git commit -m "Update stock earnings calendar" || echo "No changes to commit"
          git push
