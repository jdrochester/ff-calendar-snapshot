name: Fetch ForexFactory Calendar

on:
  workflow_dispatch:
  schedule:
    # Runs early enough to always be ready before 5am NY
    - cron: "0 4 * * *"

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Checkout repo
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repo
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Fetch ForexFactory feeds
      #    (last + this + next week for boundary safety)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fetch ForexFactory feeds
        run: |
          set -e
          curl -s https://nfs.faireconomy.media/ff_calendar_lastweek.xml -o lastweek.xml || true
          curl -s https://nfs.faireconomy.media/ff_calendar_thisweek.xml -o thisweek.xml || true
          curl -s https://nfs.faireconomy.media/ff_calendar_nextweek.xml -o nextweek.xml || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Convert XML â†’ JSON (DEFENSIVE + LOGGED)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Convert XML â†’ JSON
        run: |
          python3 << 'EOF'
          import json
          import xml.etree.ElementTree as ET
          from pathlib import Path

          def safe_parse(path):
              try:
                  text = path.read_text(encoding="utf-8", errors="ignore")

                  # Skip HTML / bot / malformed responses
                  if "<html" in text.lower() or not text.strip().startswith("<"):
                      print(f"âš ï¸ Skipping non-XML response: {path.name}")
                      return []

                  root = ET.fromstring(text)
                  events = []

                  for ev in root.findall(".//event"):
                      events.append({
                          "title": ev.findtext("title"),
                          "country": ev.findtext("country"),
                          "currency": ev.findtext("currency"),
                          "impact": ev.findtext("impact"),
                          "date": ev.findtext("date"),
                          "time": ev.findtext("time"),
                          "forecast": ev.findtext("forecast"),
                          "previous": ev.findtext("previous"),
                          "actual": ev.findtext("actual"),
                      })

                  return events

              except Exception as e:
                  print(f"âŒ Failed parsing {path.name}: {e}")
                  return []

          all_events = []

          for xml_file in ["lastweek.xml", "thisweek.xml", "nextweek.xml"]:
              path = Path(xml_file)

              if not path.exists():
                  print(f"âš ï¸ Missing file: {xml_file}")
                  continue

              events = safe_parse(path)
              print(f"ðŸ“„ {xml_file}: {len(events)} events")
              all_events.extend(events)

          Path("calendar.json").write_text(
              json.dumps(all_events, indent=2),
              encoding="utf-8"
          )

          print(f"âœ… Parsed {len(all_events)} total events written to calendar.json")
          EOF

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Commit updates (idempotent)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit calendar snapshot
        run: |
          git config user.name "ff-calendar-bot"
          git config user.email "bot@github.com"
          git add calendar.json
          git commit -m "Update ForexFactory calendar snapshot" || echo "No changes to commit"
          git push
